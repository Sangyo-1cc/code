<script type="module">
    import { PoseLandmarker, FilesetResolver, DrawingUtils } from "https://cdn.skypack.dev/@mediapipe/tasks-vision@0.10.12";

    const videoUpload = document.getElementById("videoUpload"), video = document.getElementById("analysisVideo"), canvasElement = document.getElementById("output_canvas"), canvasCtx = canvasElement.getContext("2d"), videoContainer = document.getElementById("videoContainer"), statusElement = document.getElementById("status"), feedbackList = document.getElementById("feedbackList"), shareStoryBtn = document.getElementById("shareStoryBtn"), uploadSection = document.getElementById('upload-section'), analysisSection = document.getElementById('analysis-section'), resultSection = document.getElementById('result-section'), storyCanvas = document.getElementById('story-canvas'), storyCtx = storyCanvas.getContext('2d'), coachFeedbackArea = document.getElementById('coach-feedback-area'), storyCanvasContainer = document.getElementById('story-canvas-container'), startAnalysisBtn = document('startAnalysisBtn'), resetBtn = document.getElementById('resetBtn'), noSquatResultArea = document.getElementById('no-squat-result-area'), initialStatus = document.getElementById('initial-status');
    
    // ìŠ¤ì¿¼íŠ¸ ë¶„ì„ ê´€ë ¨ ë³€ìˆ˜ ë³µêµ¬ ë° ì¶”ê°€
    let poseLandmarker, squatCount = 0, squatPhase = 'standing', frameCount = 0, totalScores = {}, bestMomentTime = 0, lowestKneeAngle = 180, animationFrameId, repReachedMinDepth = false, squatValidStart = false, analysisStarted = false; // squatValidEnd ì œê±°, ë” ë‹¨ìˆœí™”

    function showRegularResults() {
        if(storyCanvasContainer) storyCanvasContainer.style.display = 'block';
        if(noSquatResultArea) noSquatResultArea.style.display = 'none';
        if(coachFeedbackArea) coachFeedbackArea.style.display = 'block';
        if(shareStoryBtn) shareStoryBtn.style.display = 'block';
    }

    function showNoSquatResults() {
        if(storyCanvasContainer) storyCanvasContainer.style.display = 'none';
        if(noSquatResultArea) {
            noSquatResultArea.innerHTML = `<h2>ë¶„ì„ ì‹¤íŒ¨! ğŸ¤–</h2><p style="margin-top: 20px;">ìœ íš¨í•œ ìŠ¤ì¿¼íŠ¸ ë™ì‘ì„ ì¸ì‹í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p><p>ìì„¸ë‚˜ ì˜ìƒ ê°ë„ë¥¼ í™•ì¸ í›„ ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”.</p>`;
            noSquatResultArea.style.display = 'block';
        }
        if(coachFeedbackArea) coachFeedbackArea.style.display = 'none';
        if(shareStoryBtn) shareStoryBtn.style.display = 'none';
    }

    function getQualitativeFeedback(score) {
        if (score >= 90) return "ì™„ë²½ì— ê°€ê¹Œìš´ ìŠ¤ì¿¼íŠ¸! ìì„¸ êµë³¸ìœ¼ë¡œ ì¨ë„ ë˜ê² ì–´ìš”. ğŸ‘";
        if (score >= 80) return "í›Œë¥­í•´ìš”! ì•ˆì •ì ì¸ ìì„¸ê°€ ë‹ë³´ì…ë‹ˆë‹¤. ì—¬ê¸°ì„œ ë§Œì¡±í•˜ì§€ ì•Šìœ¼ì‹¤ ê±°ì£ ? ğŸ˜‰";
        if (score >= 70) return "ì¢‹ì•„ìš”! ê¸°ë³¸ê¸°ê°€ íƒ„íƒ„í•˜ì‹œë„¤ìš”. ì¡°ê¸ˆë§Œ ë” ê¹Šì´ì— ì‹ ê²½ ì“°ë©´ ì™„ë²½í•  ê±°ì˜ˆìš”.";
        if (score >= 50) return "ì˜í•˜ê³  ìˆì–´ìš”! ì¡°ê¸ˆë§Œ ë” ê¾¸ì¤€íˆ í•˜ë©´ ê¸ˆë°© ì¢‹ì•„ì§ˆ ê±°ì˜ˆìš”. í™”ì´íŒ…!";
        if (score >= 30) return "ìŒ, ì´ê²Œ ìŠ¤ì¿¼íŠ¸ì¼ê¹Œìš”? ğŸ•º ì—´ì •ì€ 100ì ! ìì„¸ëŠ” ìš°ë¦¬ì™€ í•¨ê»˜ ë§Œë“¤ì–´ê°€ìš”!";
        return "ì•—, ì•‰ìœ¼ë ¤ë‹¤ ë§ˆì‹  ê±´ ì•„ë‹ˆì£ ? ğŸ˜… ê´œì°®ì•„ìš”, ëª¨ë“  ì‹œì‘ì€ ë¯¸ì•½í•˜ë‹ˆê¹Œìš”!";
    }

    async function createShareableImage(finalScore, qualitativeFeedback) {
        if (!video.duration || !video.videoWidth || !video.videoHeight) return;
        storyCanvas.style.display = 'block';
        const tempVideoCanvas = document.createElement('canvas');
        const tempVideoCtx = tempVideoCanvas.getContext('2d');

        video.currentTime = bestMomentTime;
        await new Promise(resolve => { video.onseeked = resolve; });
        
        tempVideoCanvas.width = video.videoWidth;
        tempVideoCanvas.height = video.videoHeight;
        tempVideoCtx.drawImage(video, 0, 0, tempVideoCanvas.width, tempVideoCanvas.height);

        const storyWidth = 1080, storyHeight = 1920;
        storyCanvas.width = storyWidth;
        storyCanvas.height = storyHeight;

        storyCtx.fillStyle = '#1a1a1a';
        storyCtx.fillRect(0, 0, storyWidth, storyHeight);

        const gradient = storyCtx.createLinearGradient(0, 0, 0, storyHeight);
        gradient.addColorStop(0, 'rgba(0,0,0,0.6)');
        gradient.addColorStop(0.5, 'rgba(0,0,0,0.2)');
        gradient.addColorStop(1, 'rgba(0,0,0,0.8)');
        storyCtx.fillStyle = gradient;
        storyCtx.fillRect(0, 0, storyWidth, storyHeight);

        const videoAspectRatio = tempVideoCanvas.width / tempVideoCanvas.height;
        const outputWidth = storyWidth;
        const outputHeight = outputWidth / videoAspectRatio;
        const yPos = (storyHeight - outputHeight) / 2.5;

        storyCtx.drawImage(tempVideoCanvas, 0, yPos, outputWidth, outputHeight);

        storyCtx.font = 'bold 120px "Noto Sans KR", sans-serif';
        storyCtx.fillStyle = 'white';
        storyCtx.textAlign = 'center';
        storyCtx.shadowColor = 'rgba(0,0,0,0.5)';
        storyCtx.shadowBlur = 10;
        storyCtx.fillText('âœ¨ ìµœê³ ì˜ ìˆœê°„ âœ¨', storyWidth / 2, yPos - 50);

        storyCtx.font = 'bold 250px "Noto Sans KR", sans-serif';
        storyCtx.fillStyle = '#FFC107';
        storyCtx.fillText(finalScore, storyWidth / 2, storyHeight - 350);

        storyCtx.font = '60px "Noto Sans KR", sans-serif';
        storyCtx.fillStyle = 'white';
        storyCtx.fillText('/100', storyWidth / 2 + 250, storyHeight - 350);

        storyCtx.shadowBlur = 0;
        storyCtx.font = '55px "Noto Sans KR", sans-serif';
        wrapText(storyCtx, qualitativeFeedback, storyWidth / 2, storyHeight - 200, storyWidth - 100, 70);
    }

    function wrapText(context, text, x, y, maxWidth, lineHeight) {
        const words = text.split(' ');
        let line = '';
        for(let n = 0; n < words.length; n++) {
            let testLine = line + words[n] + ' ';
            let metrics = context.measureText(testLine);
            if (metrics.width > maxWidth && n > 0) {
                context.fillText(line, x, y);
                line = words[n] + ' ';
                y += lineHeight;
            } else {
                line = testLine;
            }
        }
        context.fillText(line, x, y);
    }

    function updateStatus(message, isLoading = false) {
        if (statusElement) statusElement.innerHTML = isLoading ? `<span class="loading"></span> ${message}` : message;
    }

    function calculateAngle(a, b, c) {
        const r = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
        let ang = Math.abs(r * 180.0 / Math.PI);
        if (ang > 180.0) ang = 360 - ang;
        return ang;
    }

    // ìŠ¤ì¿¼íŠ¸ ë¶„ì„ ë¡œì§ ì¬ì¡°ì •
    function analyzeSquat(landmarks) {
        // ëœë“œë§ˆí¬ ìœ íš¨ì„± ê²€ì‚¬ ê°•í™” ë° í•„ìˆ˜ ëœë“œë§ˆí¬ ì²´í¬
        const requiredLandmarks = [11, 12, 23, 24, 25, 26, 27, 28]; // ì–´ê¹¨, ì—‰ë©ì´, ë¬´ë¦, ë°œëª©

        if (!landmarks || landmarks.length === 0 || !landmarks[0]) {
            // console.warn("ëœë“œë§ˆí¬ ë°ì´í„° ì—†ìŒ.");
            return;
        }
        const pose = landmarks[0];

        // í•„ìˆ˜ ëœë“œë§ˆí¬ê°€ ëª¨ë‘ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
        for (let i = 0; i < requiredLandmarks.length; i++) {
            if (!pose[requiredLandmarks[i]] || pose[requiredLandmarks[i]].visibility < 0.7) { // visibility ì„ê³„ê°’ ì¶”ê°€
                // console.warn("í•„ìˆ˜ ëœë“œë§ˆí¬ ì¤‘ ì¼ë¶€ê°€ ê°ì§€ë˜ì§€ ì•Šê±°ë‚˜ ê°€ì‹œì„±ì´ ë‚®ìŒ. ìŠ¤ì¿¼íŠ¸ ë¶„ì„ ê±´ë„ˆëœ€.");
                return; // í•„ìˆ˜ ëœë“œë§ˆí¬ ì¤‘ í•˜ë‚˜ë¼ë„ ì—†ê±°ë‚˜ ê°€ì‹œì„±ì´ ë‚®ìœ¼ë©´ ë¶„ì„ ê±´ë„ˆë›°ê¸°
            }
        }
        
        const leftHip = pose[23];
        const rightHip = pose[24];
        const leftKnee = pose[25];
        const rightKnee = pose[26];
        const leftAnkle = pose[27];
        const rightAnkle = pose[28];
        const leftShoulder = pose[11];
        const rightShoulder = pose[12];
        
        const hip = {x:(leftHip.x + rightHip.x)/2, y:(leftHip.y + rightHip.y)/2};
        const knee = {x:(leftKnee.x + rightKnee.x)/2, y:(leftKnee.y + rightKnee.y)/2};
        const ankle = {x:(leftAnkle.x + rightAnkle.x)/2, y:(leftAnkle.y + rightAnkle.y)/2};
        const shoulder = {x:(leftShoulder.x + rightShoulder.x)/2, y:(leftShoulder.y + rightShoulder.y)/2};

        // ë¬´ë¦ ê°ë„ (ë‘”ë¶€-ë¬´ë¦-ë°œëª©)
        const kneeAngle = (calculateAngle(hip, knee, ankle)); 

        // ìƒì²´ ê°ë„ (ì–´ê¹¨-ì—‰ë©ì´-ìˆ˜ì§)
        const vertical = { x: hip.x, y: hip.y - 1 };
        const torsoAngle = calculateAngle(shoulder, hip, vertical);

        // ê°€ì¥ ë‚®ì€ ë¬´ë¦ ê°ë„ ê¸°ë¡ (ìµœê³ ì˜ ìˆœê°„ ê°ì§€ìš©)
        if (kneeAngle < lowestKneeAngle) {
            lowestKneeAngle = kneeAngle;
            bestMomentTime = video.currentTime;
        }

        // --- ìŠ¤ì¿¼íŠ¸ ìì„¸ ì ìˆ˜ ê³„ì‚° (ê¸°ì¡´ ë¡œì§ ìœ ì§€, í•„ìš”ì‹œ ê°œì„ ) ---
        let depthScore = 0;
        if (kneeAngle <= 90) depthScore = 100;
        else if (kneeAngle <= 110) depthScore = Math.max(0, 100 - (kneeAngle - 90) * 2.5);
        else depthScore = Math.max(0, 50 - (kneeAngle - 110) * 1.5);
        
        let backScore = 0;
        const idealTorsoMin = 10;
        const idealTorsoMax = 50;
        
        if (torsoAngle >= idealTorsoMin && torsoAngle <= idealTorsoMax) {
            backScore = 100;
        } else if (torsoAngle < idealTorsoMin) {
            backScore = Math.max(0, 100 - (idealTorsoMin - torsoAngle) * 5);
        } else {
            backScore = Math.max(0, 100 - (torsoAngle - idealTorsoMax) * 3);
        }
        // --- ìŠ¤ì¿¼íŠ¸ ìì„¸ ì ìˆ˜ ê³„ì‚° ë ---

        // --- ìŠ¤ì¿¼íŠ¸ íšŸìˆ˜ ì¹´ìš´íŒ… ë¡œì§ (ê¸°ì¡´ ì‘ë™ ë¡œì§ ê¸°ë°˜ìœ¼ë¡œ ë‹¨ìˆœí™” ë° ì¡°ì •) ---
        // ê¸°ì¡´ ì½”ë“œì˜ ì„ê³„ê°’ì— ë§ì¶° ì¡°ì •: standing 165ë„, bottom 100ë„
        const standingThreshold = 160; // ë¬´ë¦ì´ ê±°ì˜ í´ì§„ ìƒíƒœ (ê¸°ì¡´ 165ë³´ë‹¤ ì•½ê°„ ë‚®ì¶¤)
        const bottomThreshold = 100;   // ìŠ¤ì¿¼íŠ¸ ìµœí•˜ì  ê¸°ì¤€ (ê¸°ì¡´ê³¼ ë™ì¼)
        const descendingThreshold = 150; // ë‚´ë ¤ê°€ëŠ” ì¤‘ ê°ì§€ ì‹œì‘ (ê¸°ì¡´ 165ë³´ë‹¤ ë‚®ì¶¤)
        const ascendingThreshold = 110;  // ì˜¬ë¼ì˜¤ëŠ” ì¤‘ ê°ì§€ ì‹œì‘ (ê¸°ì¡´ 100ë³´ë‹¤ ë†’ì„)
        const minSquatDurationFrames = 5; // ìµœì†Œ ìŠ¤ì¿¼íŠ¸ ë™ì‘ ì§€ì† í”„ë ˆì„ (ê¸°ì¡´ 5ì™€ ìœ ì‚¬)

        // í™ê³¼ ë¬´ë¦ì˜ ìˆ˜ì§ì  ìœ„ì¹˜ ë³€í™”ë¥¼ ê°ì§€ (ìŠ¤ì¿¼íŠ¸ì™€ ì¶¤ êµ¬ë¶„ ì‹œë„)
        // í™ì´ ë¬´ë¦ë³´ë‹¤ ì•„ë˜ë¡œ ë‚´ë ¤ê°€ê³ , ê·¸ ë‹¤ìŒ ë¬´ë¦ì´ ë°œëª©ë³´ë‹¤ ì•„ë˜ë¡œ ë‚´ë ¤ê°€ëŠ”ì§€ í™•ì¸
        const hipToKneeVerticalDistance = hip.y - knee.y;
        const kneeToAnkleVerticalDistance = knee.y - ankle.y;
        
        // ìŠ¤ì¿¼íŠ¸ê°€ ì•„ë‹Œ ë‹¤ë¥¸ ë™ì‘(ì˜ˆ: ì¶¤)ì„ ê±¸ëŸ¬ë‚´ëŠ” ì´ˆê¸° ì‹œë„:
        // íŠ¹ì • ìˆ˜ì§ ì´ë™ ì—†ì´ëŠ” ìŠ¤ì¿¼íŠ¸ ìƒíƒœë¡œ ì§„ì…í•˜ì§€ ì•Šë„ë¡ í•¨ (ì´ˆê¸° ì‹¤í—˜ì  ì¶”ê°€)
        // hip.yê°€ shoulder.y ë³´ë‹¤ ì•½ê°„ ì•„ë˜ë¡œ ë‚´ë ¤ê°ˆ ë•Œë§Œ ì‹œì‘ (ì •ë©´ ì˜ìƒì—ì„œ ì—‰ë©ì´ í•˜ê°• ê°ì§€)
        // ì´ ì¡°ê±´ì€ ì¸¡ë©´ ì˜ìƒì—ì„œ ì˜¤ì‘ë™í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì£¼ì˜. í•„ìš”ì‹œ ì œê±°/ì¡°ì •.
        // if (squatPhase === 'standing' && hip.y > shoulder.y - 0.05) { // ì—‰ë©ì´ê°€ ì–´ê¹¨ë³´ë‹¤ ì‚´ì§ì´ë¼ë„ ì•„ë˜ë¡œ ë‚´ë ¤ê°€ì•¼ ì‹œì‘
        //     squatValidStart = true;
        // }


        let currentPhase = squatPhase;

        if (kneeAngle > standingThreshold) { // ë¬´ë¦ì´ í´ì§„ ìƒíƒœ
            currentPhase = 'standing';
            if (squatPhase === 'ascending' && repReachedMinDepth && frameCount >= minSquatDurationFrames) {
                // ìœ íš¨í•œ ìŠ¤ì¿¼íŠ¸(ìµœì†Œ ê¹Šì´ ë„ë‹¬ ë° ìµœì†Œ í”„ë ˆì„ ë§Œì¡±) í›„ ìŠ¤íƒ ë”©ìœ¼ë¡œ ëŒì•„ì˜¤ë©´ íšŸìˆ˜ ì¦ê°€
                squatCount++;
                console.log("ìŠ¤ì¿¼íŠ¸ íšŸìˆ˜:", squatCount);
            }
            // ìŠ¤ì¿¼íŠ¸ ì‚¬ì´í´ ì´ˆê¸°í™”
            repReachedMinDepth = false;
            frameCount = 0;
            totalScores = { depth: 0, backPosture: 0 };
        } else if (kneeAngle <= descendingThreshold && squatPhase === 'standing') {
            // ì„œìˆëŠ” ìƒíƒœì—ì„œ ë¬´ë¦ì´ êµ¬ë¶€ëŸ¬ì§€ê¸° ì‹œì‘
            currentPhase = 'descending';
            frameCount = 0; // ìƒˆë¡œìš´ ìŠ¤ì¿¼íŠ¸ ì‹œì‘
        } else if (kneeAngle <= bottomThreshold && (squatPhase === 'descending' || squatPhase === 'bottom')) {
            // ìµœí•˜ì  ë„ë‹¬
            currentPhase = 'bottom';
            repReachedMinDepth = true; // ìµœì†Œ ê¹Šì´ ë„ë‹¬ í”Œë˜ê·¸ ì„¤ì •
        } else if (kneeAngle > ascendingThreshold && (squatPhase === 'descending' || squatPhase === 'bottom')) {
            // ìµœí•˜ì ì—ì„œ ì˜¬ë¼ì˜¤ëŠ” ì¤‘
            currentPhase = 'ascending';
        }

        squatPhase = currentPhase;

        // ìŠ¤ì¿¼íŠ¸ ë™ì‘ ì¤‘ì¼ ë•Œë§Œ ì ìˆ˜ ëˆ„ì 
        if (squatPhase !== 'standing') {
            frameCount++;
            totalScores.depth += depthScore;
            totalScores.backPosture += backScore; // 'backScore' ì‚¬ìš©
        }
    }
   
    async function createPoseLandmarker() {
        initialStatus.innerHTML = `<span class="loading"></span> AI ëª¨ë¸ì„ ë¡œë”©ì¤‘ì…ë‹ˆë‹¤...`;
        try {
            const filesetResolver = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.12/wasm");
            poseLandmarker = await PoseLandmarker.createFromOptions(filesetResolver, {
                baseOptions: {
                    modelAssetPath: `https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task`,
                    delegate: "GPU" // ê°€ëŠ¥í•œ ê²½ìš° GPU ì‚¬ìš© (ì„±ëŠ¥ í–¥ìƒ)
                },
                runningMode: "VIDEO",
                numPoses: 1
            });
            initialStatus.textContent = 'AI ëª¨ë¸ ì¤€ë¹„ ì™„ë£Œ!';
        } catch (error) {
            console.error("ëª¨ë¸ ë¡œë”© ì‹¤íŒ¨:", error);
            initialStatus.textContent = 'âŒ ëª¨ë¸ ë¡œë”© ì‹¤íŒ¨. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.';
        }
    }

    function resetApp() {
        squatCount = 0;
        frameCount = 0;
        squatPhase = 'standing';
        bestMomentTime = 0;
        lowestKneeAngle = 180;
        repReachedMinDepth = false;
        analysisStarted = false;
        uploadSection.style.display = 'block';
        analysisSection.style.display = 'none';
        resultSection.style.display = 'none';
        startAnalysisBtn.disabled = false;
        startAnalysisBtn.textContent = "ì´ ì˜ìƒìœ¼ë¡œ ë¶„ì„ ì‹œì‘í•˜ê¸° ğŸ”¬";
        if(video.src) {
            video.pause();
            video.removeAttribute('src');
            video.load();
        }
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
        }
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height); // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
        initialStatus.textContent = ''; // ì´ˆê¸° ìƒíƒœ ë©”ì‹œì§€ ë¹„ìš°ê¸°
    }

    function handleVideoUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        uploadSection.style.display = 'none';
        analysisSection.style.display = 'block';
        
        const fileURL = URL.createObjectURL(file);
        video.src = fileURL;
        video.play();
    }

    function setupVideoDisplay() {
        const aspectRatio = video.videoWidth / video.videoHeight;
        let newWidth = videoContainer.clientWidth;
        let newHeight = newWidth / aspectRatio;

        videoContainer.style.height = `${newHeight}px`;
        canvasElement.width = newWidth;
        canvasElement.height = newHeight;
        
        previewLoop();
    }

    function previewLoop() {
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        if (video.paused || video.ended) return;

        canvasCtx.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
        animationFrameId = requestAnimationFrame(previewLoop);
    }

    function startAnalysis() {
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        analysisStarted = true;
        updateStatus('ğŸ”¬ ë¶„ì„ ì¤‘...', true);
        startAnalysisBtn.disabled = true;
        startAnalysisBtn.textContent = "ë¶„ì„ ì¤‘...";
        video.loop = false;
        video.currentTime = 0;
        video.play();
        processVideoFrame();
    }

    async function endAnalysis() {
        updateStatus('âœ… ë¶„ì„ ì™„ë£Œ!');
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
        }
        analysisSection.style.display = 'none';
        resultSection.style.display = 'block';

        if (squatCount > 0 && frameCount > 0) {
            showRegularResults();
            const finalScores = {
                depth: Math.round(totalScores.depth / frameCount),
                backPosture: Math.round(totalScores.backPosture / frameCount)
            };
            const finalTotalScore = Math.round((finalScores.depth + finalScores.backPosture) / 2);
            const qualitativeFeedback = getQualitativeFeedback(finalTotalScore);
            
            await createShareableImage(finalTotalScore, qualitativeFeedback);
            feedbackList.textContent = qualitativeFeedback;

            const resultData = {
                squatCount,
                totalScore: finalTotalScore,
                depthScore: finalScores.depth,
                backPosture: finalScores.backPosture
            };
            google.script.run
                .withSuccessHandler(r => console.log("ì‹œíŠ¸ ê¸°ë¡ ì„±ê³µ:",r))
                .withFailureHandler(e => console.error("ì‹œíŠ¸ ê¸°ë¡ ì‹¤íŒ¨:",e))
                .logSquatData(resultData);
        } else {
            showNoSquatResults();
        }
    }

    function processVideoFrame() {
        if (!poseLandmarker || video.ended) {
            if (video.ended) endAnalysis();
            return;
        }

        poseLandmarker.detectForVideo(video, performance.now(), (result) => {
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);

            const drawingUtils = new DrawingUtils(canvasCtx);
            if (result.landmarks && result.landmarks.length > 0) {
                drawingUtils.drawLandmarks(result.landmarks[0], {color: '#FFC107', lineWidth: 2});
                drawingUtils.drawConnectors(result.landmarks[0], PoseLandmarker.POSE_CONNECTIONS, {color: '#FFFFFF', lineWidth: 2});
                analyzeSquat(result.landmarks);
            }
        });
        animationFrameId = requestAnimationFrame(processVideoFrame);
    }
   
    videoUpload.addEventListener('change', handleVideoUpload);
    video.addEventListener('loadedmetadata', setupVideoDisplay);
    video.addEventListener('ended', () => { if(!video.loop && analysisStarted) endAnalysis(); });
    startAnalysisBtn.addEventListener('click', (event) => { event.preventDefault(); startAnalysis(); });
    resetBtn.addEventListener('click', (event) => { event.preventDefault(); videoUpload.value = ''; resetApp(); });
    shareStoryBtn.addEventListener('click', (event) => { event.preventDefault();
        if (squatCount === 0) {
            alert("ìŠ¤ì¿¼íŠ¸ê°€ ê°ì§€ë˜ì§€ ì•Šì•„ ê²°ê³¼ ì´ë¯¸ì§€ë¥¼ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }
        const dataURL = storyCanvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.download = `squat-analysis-story-${Date.now()}.png`;
        link.href = dataURL;
        link.click();
    });
    document.addEventListener('DOMContentLoaded', createPoseLandmarker);
</script>
